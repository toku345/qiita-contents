---
title: ClojureScriptã‚’ä½¿ã£ã¦Google Home ã« say ã•ã›ã‚‹
tags:
  - ClojureScript
  - Say
  - GoogleHome
private: false
updated_at: "2018-12-18T00:05:51+09:00"
id: 824d12f4a0e4248784ca
organization_url_name: null
slide: false
---

çš†ã•ã¾ã€ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚
è‡ªç§°ã€Œæ°¸é ã® Clojure Newbieã€[toku345](https://twitter.com/toku345)ã§ã™ã€‚

2018 å¹´ã‚‚ Clojure Advent Calendar ã«é¦³ã›å‚ã˜ã¾ã—ãŸã€‚

**ãŠé¡˜ã„**
æœ¬è¨˜äº‹ã¯ã¶ã£ã¡ã‚ƒã‘ãã‚“ãªã«æ·±ã„å†…å®¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“...
å„ç¨®ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§èƒƒã‚‚ãŸã‚Œã—ãŸéš›ã®ç®¸ä¼‘ã‚ç¨‹åº¦ã«ãŠèª­ã¿ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚

å»å¹´ã¯ [ClojureScript ã§ Alexa ã‚¹ã‚­ãƒ«ã‚’æ›¸ã„ã¦ã¿ãŸ](https://qiita.com/toku345/items/833d81e264d870531327) ã¨ã„ã†å†…å®¹ã§æ›¸ã‹ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
ä»Šå¹´ã¯ ClojureScript ã§ Google Actions[^1] ä½œæˆãƒã‚¿ã§ã‚‚æ›¸ãã‹...ã¨è€ƒãˆã¦ã„ãŸã®ã§ã™ãŒã€ãã‚Œã ã¨ã‚ã¾ã‚Šé¢ç™½ããªã•ãã†ãªã®ã§ã€ã¡ã‚‡ã£ã¨è¶£å‘ã‚’å¤‰ãˆã¦ Google Home ç‰ˆ `say` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸ[^2]ã€‚

[^1]: Alexa ã§è¨€ã†ã¨ã“ã‚ã® Skill ã®ã“ã¨
[^2]: ã¨ã„ã†ã®ã¯ã‚¿ãƒ†ãƒã‚¨ã§ã€ãƒ›ãƒ³ãƒã¯ä¼šç¤¾ã® Advent Calendar ã‚„ä¼šç¤¾ãƒ–ãƒ­ã‚°ã€ãŠã¾ã‘ã«å‰ã€…è·ã® Advent Calendar ã«ã‚‚å¬å–šã•ã‚Œã¦ã—ã¾ã£ãŸã®ã§ã€ä½™è£•ãŒç„¡ã‹ã£ãŸã®ã§ã™ã€‚ã”ã‚ã‚“ãªã•ã„...

# say ã‚³ãƒãƒ³ãƒ‰ã¨ä½•ï¼Ÿ

macOS ã«å‚™ã‚ã£ã¦ã„ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ä»»æ„ã®æ–‡å­—åˆ—ã‚’éŸ³å£°ã«ã—ã¦å†ç”Ÿã—ã¦ãã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
ä½¿ã„æ–¹ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã€console ã‚’é–‹ã„ã¦

```console
$ say "ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ"
```

ã¨å…¥åŠ›ã™ã‚‹ã¨ã€mac ãŒ ã€Œã“ã‚“ã«ã¡ã¯ä¸–ç•Œã€ã¨ã—ã‚ƒã¹ã£ã¦ãã‚Œã¾ã™ã€‚

ã“ã‚Œã‚’ mac ã§ã¯ãªãã€Google ã€€ Home ãŒã—ã‚ƒã¹ã‚‹ã‚ˆã†ãƒˆãƒ©ã‚¤ã—ã¦ã¿ã¾ã—ãŸã€‚

# å®Ÿç¾æ–¹æ³•ã®èª¬æ˜

Text -> éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã—ã¦ã€Goole Home ã«å–‹ã‚‰ã›ã‚‹ã¨ã„ã†éƒ¨åˆ†ã¯ [google-home-notifier](https://github.com/noelportugal/google-home-notifier) ã¨ã„ã† npm ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚ã£ã¨ã„ã†é–“ã«è§£æ±ºã—ã¾ã—ãŸ ğŸ˜†

## Google Home Notifier ã®å½¹å‰²ã‚Š

1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã® Google Home Mini æ¢ç´¢
   - mDNS ã‚’ä½¿ã£ã¦åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã‚’æ¢ç´¢ã—ã¦ Google Home ã‚’è¦‹ã¤ã‘ã¾ã™[^3]ã€‚

[^3]: è©¦ã—ã¦ã¿ãŸæ‰€ã€æ‰‹å…ƒã®ç’°å¢ƒã§ã¯å‹•ã‹ãªã‹ã£ãŸã®ã§ã€ä»Šå›ã¯ Google Home ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç›´æ¥æŒ‡å®šã—ã¦ç‹™ã„æ’ƒã¡ã—ã¦ã„ã¾ã™ã€‚

2. text â†’ éŸ³å£°å¤‰æ›

   - Google ã® Cloud text-to-speech ã‚’ä½¿ã£ã¦ text â†’ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã—ã€éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« URL ã‚’å–å¾—ã™ã‚‹

3. Google Home ã«å–‹ã‚‰ã›ã‚‹ï¼ˆ=å†ç”Ÿã•ã›ã‚‹ï¼‰
   - Chromecast cast v2 ãƒ—ãƒ­ãƒˆã‚³ãƒ«[^4]ã‚’ä½¿ã£ã¦ Google Home ã«ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿã•ã›ã‚‹

[^4]: Google ã¯ Chromecast / Google Home ã¨ã®ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å…¬é–‹ã—ã¦ã„ãªã„ã®ã§ã€æœ‰å¿—ãŒè§£æã—ãŸã‚‚ã®ã‚’ãã†å‘¼ã‚“ã§ã„ã‚‹ã¿ãŸã„ã€‚è©³ã—ãã¯ [node-castv2](https://github.com/thibauts/node-castv2#an-implementation-of-the-chromecast-castv2-protocol)ã‚’å‚ç…§ã—ã¦ãã ã•ã„

## google-home-notifier ã®ã‚·ãƒ³ãƒ—ãƒ«ãªä½¿ç”¨ä¾‹

```javascript
var googlehome = require("google-home-notifier");
var language = "ja"; // if not set 'us' language will be used

googlehome.ip("192.168.3.11", language);

googlehome.notify("Hey ClojureScript", function (res) {
  console.log(res);
});
```

ã“ã‚Œã‚’ ClojureScript ã§æ›¸ã„ã¦ã¿ã‚‹ã¨ â†“

```clojure
(require '["google-home-notifier" :as googlehome])

(defonce device-ip "192.168.3.11")
(defonce language "ja")

(.ip googlehome device-ip language)
(.notify googlehome "Hey ClojureScript" (fn [res] (prn res)))

```

## æ§‹æˆå›³

![Untitled Diagram (1).png](https://qiita-image-store.s3.amazonaws.com/0/13998/888cc626-215c-5b11-e4d3-7ab844cbb55f.png)

## Let's Coding in ClojureScript!

ãã‚Œã§ã¯ã€say ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ console ä¸Šã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼

ä»Šå›ã¯ ClojureScript -> JavaScript ã¯ [shadow-cljs](http://shadow-cljs.org/) ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

Leiningen & cljsbuild ã®çµ„ã¿åˆã‚ã›ã‚ˆã‚Šã‚‚ã‚¹ãƒˆãƒ¬ã‚¹ç„¡ãä½¿ãˆã¦ã‚ˆã‹ã£ãŸã§ã™[^5]ã€‚

[^5]: å»å¹´ã€Alexa Skill ã‚’ä½œã£ãŸéš›ã¯ Leiningen & cljsbuild ã‚’ä½¿ã£ãŸã®ã§ã™ãŒã€REPL ã®ç«‹ã¡ä¸ŠãŒã‚Šã‚„ build ã®å¾…ã¡æ™‚é–“ãŒé•·ãã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã”ã¡ã‚ƒã”ã¡ã‚ƒã—ã¦ã„ã¦è‹¦åŠ´ã—ã¾ã—ãŸ...

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

â€»ã€€ build æ™‚ä½œæˆã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä¸€éƒ¨çœç•¥ã—ã¦ã„ã¾ã™

```console
.
â”œâ”€â”€ node_modules/
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ shadow-cljs.edn
â””â”€â”€ src/
Â Â Â  â””â”€â”€ main/
Â Â Â      â””â”€â”€ app/
Â Â Â          â””â”€â”€ core.cljs
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ â˜ºï¸

```clojure:shadow-cljs.edn
{:source-paths
 ["src/main"]

 :dependencies
 []

 :builds
 {:app {:target :node-script
        :output-to "bin/say"
        :main app.core/main!
        :devtools {:after-load app.core/reload!}}}

```

npm ã‚’ä½¿ã„ãŸã„å ´åˆã¯åˆ¥é€” package.json ã§ç®¡ç†ã™ã‚Œã° OK ãªã®ã§ã€ã™ã”ããŠæ‰‹è»½ã§ã™ã€‚

â€» google-tts ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ã«æœ¬å®¶ãŒè¿½å¾“ã—ã¦ãã‚Œãªã„ã®ã§ã€ä»Šå›ã¯ç§ãŒ fork ã—ã¦æ‰‹ã‚’å…¥ã‚ŒãŸã‚‚ã®ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

```json:package.json
{
  "dependencies": {
    "google-home-notifier": "toku345/google-home-notifier#update-google-tts-api"
  },
  "devDependencies": {
    "shadow-cljs": "^2.7.8",
    "source-map-support": "^0.5.9",
    "ws": "^6.1.2"
  },
  "scripts": {
    "watch": "shadow-cljs watch app",
    "test": "shadow-cljs compile test",
    "build": "shadow-cljs compile app"
  }
}
```

npm install ã™ã‚Œã°ã€ClojureScript ã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

è‚å¿ƒã® ClojureScript ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```clojure:src/main/app/core.cljs
(ns app.core
  (:require ["google-home-notifier" :as googlehome]))

(defonce device-ip "192.168.3.11")
(defonce language "ja")

(defn say [text]
  (.ip googlehome device-ip language)
  (.notify googlehome text (fn [res] (prn res))))

(defn reload! []
  (println "Code updated."))

(defn main! [& args]
  (say (first args)))
```

# build

```console
$ npx shadow-cljs release app
$ chmod +x bin/say
```

ã“ã‚Œã§ã€€ bin/say ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå®Ÿä½“ã¯ node.js ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰ãŒç”Ÿæˆã•ã‚Œ

```console
$ ./bin/say "ã“ã‚“ã«ã¡ã¯ClojureScript"
```

ã¨å®Ÿè¡Œã¨ã€Google Home ãŒã€Œã“ã‚“ã«ã¡ã¯ ClojureScriptã€ã¨ say ã—ã¦ãã‚Œã¾ã™ã€‚

# ãƒ‡ãƒ¢

ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://github.com/toku345/say-ghome) â€» ä¸€éƒ¨é–‹ç™ºã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚“ã§ã„ã‚‹ãŸã‚ â†‘ ã¨å®Œå…¨ä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“...

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">GoogleHomeã‚’å–‹ã‚‰ã›ã‚‹ say ã‚³ãƒãƒ³ãƒ‰ã‚’ ClojureScript ã§æ›¸ã„ã¦ã¿ã¾ã—ãŸï¼<a href="https://t.co/lqMUuklSej">https://t.co/lqMUuklSej</a> <a href="https://t.co/TXteXg94cF">pic.twitter.com/TXteXg94cF</a></p>&mdash; Fumitaka Tokumitsu (@toku345) <a href="https://twitter.com/toku345/status/1074673729613979649?ref_src=twsrc%5Etfw">2018å¹´12æœˆ17æ—¥</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

# ã¾ã¨ã‚

- ClojureScript + shadow-cljs ã‚’ä½¿ãˆã°ã€ã™ã”ãç°¡å˜ã« npm ã¨é€£æºã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‘ã‚‹
- google-home-notify ã‚’ä½¿ãˆã°ç°¡å˜ã« Google Home ãŠã—ã‚ƒã¹ã‚Šã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹
- ClojureScript æ›¸ãã®ã™ã£ã”ãæ¥½ã—ã„ã‚ˆ
